/*
 * File: app/controller/UserAccountForm.js
 *
 * This file was generated by Sencha Architect version 2.2.3.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Sencha Touch 2.3.x library, under independent license.
 * License of Sencha Architect does not include license for Sencha Touch 2.3.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('FP.controller.UserAccountForm', {
    extend: 'Ext.app.Controller',

    config: {
        routes: {
            'userAccountForm': 'showUserAccountForm',
            'userAccountForm/edit': 'showUserAccountFormEdit'
        },

        control: {
            "button#saveUserAccount": {
                tap: 'onSaveUserAccountTap'
            },
            "hiddenfield#account_id": {
                initialize: 'onAccount_idInitialize'
            }
        }
    },

    onSaveUserAccountTap: function(button, e, eOpts) {
        var account = Ext.ComponentQuery.query('#userAccountForm')[0],
            accountValues = account.getValues(),
            store = Ext.getStore('userAccounts'),
            model = Ext.create('FP.model.UserAccount', accountValues),
            errorMessage,
            errors = model.validate();


        if(account.edit) {
            // get record in local storage and set new values and sync...
            var id = FP.config.Runtime.getUserAccount().userAccountId,
                index = store.findExact('id', id),
                record = store.getAt(index);

            //record.set('firstName', accountValues.firstName);
            //record.set('lastName', accountValues.lastName);

            //store.sync();
            //this.redirectTo('accounts');


        } else {

            if(!errors.isValid()) {
                errors.each(function(err) {
                    errorMessage += err.getMessage() + '\n';
                });

                alert('Work in progress'+errorMessage);
                console.log(errorMessage);

            } else {

                model.set('balance', 0);
                store.add(model);
                store.sync();
                FP.config.Runtime.setUserAccount(model.data);
                FP.app.updateNumberOfAccounts();
                this.redirectTo('userAccounts');
            }
        }
    },

    onAccount_idInitialize: function(component, eOpts) {
        component.setValue(FP.config.Runtime.getAccount().id);
    },

    showUserAccountForm: function() {
        var main = Ext.getCmp('main'),
            addUserAccount = Ext.create('FP.view.UserAccountForm'),
            back = main.query('#back')[0];

        back.view = '#userAccountForm';
        back.show();

        main.setActiveItem(addUserAccount);
    },

    showUserAccountFormEdit: function() {

    }

});